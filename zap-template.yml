parameters:
  - name: targetUrl
    type: string
  - name: appName
    type: string
  - name: scanType
    type: string
  - name: reportTemplate
    type: string

steps:
- script: |
    echo "Starting ZAP Scan for ${{ parameters.appName }}..."
    echo "Target URL: ${{ parameters.targetUrl }}"

    ARTIFACT_DIR="$(Build.ArtifactStagingDirectory)/zap-reports"
    mkdir -p $ARTIFACT_DIR
    cd $ARTIFACT_DIR

    AUTOMATION_FILE="automation.yaml"

    # ========================================================================
    # ZAP Automation Framework config
    # ========================================================================
    cat <<EOF > $AUTOMATION_FILE
    env:
      contexts:
        - name: '${{ parameters.appName }}'
          urls:
            - '${{ parameters.targetUrl }}'
          authentication:
            method: manual
          users:
            - name: 'ci-user'
              credentials:
                session: '/zap/wrk/session.json'
      parameters:
        failOnError: true
        failOnWarning: false
        progressToStdout: true
    jobs:
    EOF

    if [ "${{ parameters.scanType }}" == "baseline" ]; then
      cat <<EOF >> $AUTOMATION_FILE
      - type: spider
        parameters:
          url: '${{ parameters.targetUrl }}'
          maxDuration: 5
      - type: passiveScan-wait
    EOF
    else
      cat <<EOF >> $AUTOMATION_FILE
      - type: spider
        parameters:
          url: '${{ parameters.targetUrl }}'
      - type: ajaxSpider
        parameters:
          url: '${{ parameters.targetUrl }}'
          maxDuration: 5
      - type: passiveScan-wait
      - type: activeScan
        parameters:
          context: '${{ parameters.appName }}'
    EOF
    fi

    # User-selected report
    cat <<EOF >> $AUTOMATION_FILE
      - type: report
        parameters:
          template: '${{ parameters.reportTemplate }}'
          reportDir: '/zap/wrk/'
          reportFile: 'zap_report_${{ parameters.appName }}_${{ parameters.scanType }}'
    EOF

    # Always export traditional-json
    cat <<EOF >> $AUTOMATION_FILE
      - type: report
        parameters:
          template: 'traditional-json'
          reportDir: '/zap/wrk/'
          reportFile: 'zap_report_${{ parameters.appName }}_${{ parameters.scanType }}.json'
    EOF

    echo "Generated Automation Plan:"
    cat $AUTOMATION_FILE

    # Copy Playwright session.json into container workspace
    if [ "${{ parameters.appName }}" == "admin" ]; then
      cp $(Pipeline.Workspace)/PlaywrightSessionAdmin/admin-session.json session.json
    else
      cp $(Pipeline.Workspace)/PlaywrightSessionAgent/agent-session.json session.json
    fi

    docker run --rm \
      -v $(pwd):/zap/wrk/:rw \
      --user root \
      ghcr.io/zaproxy/zaproxy:stable \
      zap.sh -cmd -addoninstall report-generation -autorun /zap/wrk/$AUTOMATION_FILE

    echo "ZAP scan finished."
    ls -la
  displayName: "Run ZAP Scan with Auth"

- publish: '$(Build.ArtifactStagingDirectory)/zap-reports'
  artifact: 'ZAP_Reports_${{ parameters.appName }}'
  displayName: 'Publish ZAP Scan Reports'
